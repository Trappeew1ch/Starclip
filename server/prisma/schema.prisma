generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           Int       @id @default(autoincrement())
  telegramId   BigInt    @unique
  username     String?
  firstName    String?
  lastName     String?
  photoUrl     String?
  balance      Float     @default(0)
  isAdmin      Boolean   @default(false)
  referralCode String?   @unique
  verificationCode String? @unique
  referredById Int?
  referredAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  referredBy     User?          @relation("UserReferrals", fields: [referredById], references: [id])
  referrals      User[]         @relation("UserReferrals")
  clips          Clip[]
  campaigns      UserCampaign[]
  socialAccounts SocialAccount[]
}

model Offer {
  id           String   @id @default(uuid())
  name         String // Creator name (e.g., "Exile", "Bratishkin")
  title        String // Campaign title
  type         String // 'YOUTUBER' | 'STREAMER'
  imageUrl     String
  avatarUrl    String?
  bannerUrl    String? // Banner image for offer card
  totalBudget  Float // Total money allocated
  paidOut      Float    @default(0) // Money already paid
  cpmRate      Float // Price per 1000 views in RUB
  language     String   @default("Russian")
  platforms    String // JSON array: ["youtube", "tiktok", "instagram"]
  description  String?
  requirements String? // JSON array of requirement strings
  assetsLink   String? // Google Drive link
  daysLeft     Int      @default(30)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clips     Clip[]
  campaigns UserCampaign[]
}

model UserCampaign {
  id       Int      @id @default(autoincrement())
  userId   Int
  offerId  String
  joinedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@unique([userId, offerId])
}

model Clip {
  id               String    @id @default(uuid())
  userId           Int
  offerId          String
  videoUrl         String
  platform         String // 'youtube' | 'tiktok' | 'instagram'
  status           String    @default("pending") // pending | approved | rejected
  views            Int       @default(0)
  likes            Int       @default(0)
  comments         Int       @default(0)
  earnedAmount     Float     @default(0)
  rejectionReason  String?
  thumbnailUrl     String?
  title            String?
  verificationCode String? // Unique hashtag e.g. #SC_AB12_XYZ99
  isVerified       Boolean   @default(false) // True when hashtag found in description
  lastStatsFetch   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)
}

model SocialAccount {
  id             Int       @id @default(autoincrement())
  userId         Int
  platform       String // 'youtube' | 'tiktok' | 'instagram'
  platformUserId String?   // User ID on the platform
  accountName    String
  profileUrl     String?
  followers      Int       @default(0)
  isConnected    Boolean   @default(true)
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
}

model Transaction {
  id        Int      @id @default(autoincrement())
  userId    Int
  clipId    String?
  amount    Float
  type      String // 'earning' | 'withdrawal' | 'bonus'
  status    String   @default("completed") // pending | completed | cancelled
  createdAt DateTime @default(now())
}
